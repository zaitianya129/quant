<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LUçš„Aè‚¡é‡åŒ–åˆ†æç³»ç»Ÿ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding-top: 70px;
            padding-bottom: 20px;
        }
        .navbar {
            background: rgba(255,255,255,0.95) !important;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .navbar-brand {
            font-weight: bold;
            color: #667eea !important;
        }
        .nav-link {
            color: #333 !important;
        }
        .nav-link:hover {
            color: #667eea !important;
        }
        .btn-outline-primary {
            color: #667eea;
            border-color: #667eea;
        }
        .btn-outline-primary:hover {
            background: #667eea;
            color: white;
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .user-info .username {
            color: #333;
            font-weight: 500;
        }
        .main-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .search-card {
            background: white;
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }
        .result-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: none;
        }
        .score-badge {
            font-size: 48px;
            font-weight: bold;
            padding: 20px;
            border-radius: 50%;
            display: inline-block;
            width: 120px;
            height: 120px;
            line-height: 80px;
            text-align: center;
        }
        .grade-A { background: #10b981; color: white; }
        .grade-B { background: #3b82f6; color: white; }
        .grade-C { background: #f59e0b; color: white; }
        .grade-D { background: #ef4444; color: white; }
        .grade-E { background: #7f1d1d; color: white; }
        .signal-icon {
            font-size: 24px;
            margin-right: 8px;
        }
        .strategy-table th {
            background: #f8f9fa;
        }
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar navbar-expand-lg fixed-top">
        <div class="container">
            <a class="navbar-brand" href="/">LUçš„Aè‚¡é‡åŒ–åˆ†æç³»ç»Ÿ</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
                <!-- æœªç™»å½•çŠ¶æ€ -->
                <div id="authButtons" class="d-none">
                    <a href="/login" class="btn btn-outline-primary me-2">ç™»å½•</a>
                    <a href="/register" class="btn btn-primary">æ³¨å†Œ</a>
                </div>
                <!-- å·²ç™»å½•çŠ¶æ€ -->
                <div id="userInfo" class="user-info d-none">
                    <span class="username">æ¬¢è¿, <span id="usernameDisplay">--</span></span>
                    <button class="btn btn-outline-secondary btn-sm" onclick="handleLogout()">é€€å‡º</button>
                </div>
            </div>
        </div>
    </nav>

    <div class="main-container">
        <!-- æ ‡é¢˜ -->
        <div class="text-center mb-4">
            <h1 class="text-white display-4">ğŸ“ˆ LUçš„Aè‚¡é‡åŒ–åˆ†æç³»ç»Ÿ</h1>
            <p class="text-white">åŸºäºå¤šç­–ç•¥å›æµ‹çš„æ™ºèƒ½ä¹°å–ç‚¹åˆ†æ</p>
        </div>

        <!-- æœªç™»å½•æç¤ºå¡ç‰‡ -->
        <div class="search-card d-none" id="loginPrompt">
            <div class="text-center py-4">
                <div style="font-size: 60px; margin-bottom: 20px;">ğŸ”</div>
                <h4 class="mb-3">è¯·å…ˆç™»å½•</h4>
                <p class="text-muted mb-4">ç™»å½•åå³å¯ä½¿ç”¨è‚¡ç¥¨é‡åŒ–åˆ†æåŠŸèƒ½</p>
                <a href="/login" class="btn btn-primary btn-lg me-2">ç™»å½•</a>
                <a href="/register" class="btn btn-outline-primary btn-lg">æ³¨å†Œ</a>
            </div>
        </div>

        <!-- æœç´¢å¡ç‰‡ï¼ˆç™»å½•åæ˜¾ç¤ºï¼‰ -->
        <div class="search-card d-none" id="searchCard">
            <div class="row">
                <div class="col-md-8 offset-md-2">
                    <h4 class="mb-4 text-center">è¾“å…¥è‚¡ç¥¨ä»£ç æˆ–åç§°</h4>
                    <div class="input-group input-group-lg mb-3">
                        <input type="text" id="stockInput" class="form-control"
                               placeholder="ä¾‹å¦‚: 000001 æˆ– å¹³å®‰é“¶è¡Œ"
                               onkeypress="if(event.key==='Enter') analyzeStock()">
                        <button class="btn btn-primary" onclick="analyzeStock()">
                            ğŸ” æŸ¥è¯¢åˆ†æ
                        </button>
                    </div>
                    <div class="text-muted text-center">
                        <small>æ”¯æŒæ²ªæ·±Aè‚¡ä»£ç æŸ¥è¯¢ï¼ˆå¦‚ï¼š000001.SZ, 600000.SHï¼‰</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- åŠ è½½åŠ¨ç”» -->
        <div class="loading">
            <div class="spinner-border text-light" role="status">
                <span class="visually-hidden">åŠ è½½ä¸­...</span>
            </div>
            <p class="text-white mt-2">æ­£åœ¨åˆ†æï¼Œè¯·ç¨å€™...</p>
        </div>

        <!-- ç»“æœå¡ç‰‡ -->
        <div class="result-card" id="resultCard">
            <!-- åŸºæœ¬ä¿¡æ¯ -->
            <div class="text-center mb-4">
                <h2 id="stockName">--</h2>
                <p class="text-muted">
                    ä»£ç : <span id="stockCode">--</span> |
                    ä»·æ ¼: <span id="stockPrice">--</span>å…ƒ |
                    æ—¥æœŸ: <span id="stockDate">--</span>
                </p>
            </div>

            <!-- ç»¼åˆè¯„åˆ† -->
            <div class="text-center mb-5">
                <div class="score-badge grade-A" id="scoreBadge">
                    <span id="scoreValue">--</span>åˆ†
                </div>
                <h4 class="mt-3" id="scoreGrade">-- çº§</h4>
                <p class="text-muted" id="scoreAdvice">--</p>
            </div>

            <!-- å½“å‰ä¿¡å· -->
            <div class="mb-4">
                <h5>ğŸ“Š å½“å‰äº¤æ˜“ä¿¡å·</h5>
                <div class="row" id="signalsContainer">
                    <!-- åŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>

            <!-- ç­–ç•¥å¯¹æ¯” -->
            <div class="mb-4">
                <h5>ğŸ¯ ç­–ç•¥å›æµ‹å¯¹æ¯”ï¼ˆè¿‘3å¹´ï¼‰</h5>
                <div class="table-responsive">
                    <table class="table table-hover strategy-table">
                        <thead>
                            <tr>
                                <th>ç­–ç•¥åç§°</th>
                                <th>äº¤æ˜“æ¬¡æ•°</th>
                                <th>å¹´åŒ–æ”¶ç›Š</th>
                                <th>èƒœç‡</th>
                                <th>å¤æ™®æ¯”ç‡</th>
                                <th>æœ€å¤§å›æ’¤</th>
                            </tr>
                        </thead>
                        <tbody id="strategyTableBody">
                            <!-- åŠ¨æ€ç”Ÿæˆ -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- è¯„åˆ†æ˜ç»† -->
            <div>
                <h5>ğŸ“‹ è¯„åˆ†æ˜ç»†</h5>
                <ul id="scoreDetails">
                    <!-- åŠ¨æ€ç”Ÿæˆ -->
                </ul>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthStatus();
        });

        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        async function checkAuthStatus() {
            try {
                const response = await fetch('/api/auth/status');
                const result = await response.json();

                if (result.success && result.data.logged_in) {
                    // å·²ç™»å½•ï¼šæ˜¾ç¤ºæœç´¢æ¡†ï¼Œéšè—ç™»å½•æç¤º
                    document.getElementById('authButtons').classList.add('d-none');
                    document.getElementById('userInfo').classList.remove('d-none');
                    document.getElementById('usernameDisplay').textContent = result.data.username;
                    document.getElementById('searchCard').classList.remove('d-none');
                    document.getElementById('loginPrompt').classList.add('d-none');
                } else {
                    // æœªç™»å½•ï¼šéšè—æœç´¢æ¡†ï¼Œæ˜¾ç¤ºç™»å½•æç¤º
                    document.getElementById('authButtons').classList.remove('d-none');
                    document.getElementById('userInfo').classList.add('d-none');
                    document.getElementById('searchCard').classList.add('d-none');
                    document.getElementById('loginPrompt').classList.remove('d-none');
                }
            } catch (error) {
                console.error('æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥:', error);
                document.getElementById('authButtons').classList.remove('d-none');
                document.getElementById('loginPrompt').classList.remove('d-none');
            }
        }

        // é€€å‡ºç™»å½•
        async function handleLogout() {
            try {
                const response = await fetch('/api/auth/logout', { method: 'POST' });
                const result = await response.json();

                if (result.success) {
                    // åˆ·æ–°é¡µé¢
                    window.location.reload();
                }
            } catch (error) {
                console.error('é€€å‡ºç™»å½•å¤±è´¥:', error);
            }
        }

        // åˆ†æè‚¡ç¥¨
        async function analyzeStock() {
            const input = document.getElementById('stockInput').value.trim();
            if (!input) {
                alert('è¯·è¾“å…¥è‚¡ç¥¨ä»£ç ');
                return;
            }

            // æ˜¾ç¤ºåŠ è½½
            document.querySelector('.loading').style.display = 'block';
            document.getElementById('resultCard').style.display = 'none';

            try {
                const response = await fetch(`/api/analyze/${input}`);
                const result = await response.json();

                if (result.success) {
                    displayResult(result.data);
                } else {
                    alert('åˆ†æå¤±è´¥: ' + result.message);
                }
            } catch (error) {
                alert('è¯·æ±‚å¤±è´¥: ' + error.message);
            } finally {
                document.querySelector('.loading').style.display = 'none';
            }
        }

        // æ˜¾ç¤ºç»“æœ
        function displayResult(data) {
            // åŸºæœ¬ä¿¡æ¯
            document.getElementById('stockName').textContent = data.name;
            document.getElementById('stockCode').textContent = data.ts_code;
            document.getElementById('stockPrice').textContent = data.current_price.toFixed(2);
            document.getElementById('stockDate').textContent = data.current_date;

            // ç»¼åˆè¯„åˆ†
            const score = data.score;
            document.getElementById('scoreValue').textContent = score.total;
            document.getElementById('scoreGrade').textContent = score.grade + ' çº§';
            document.getElementById('scoreAdvice').textContent = score.advice;

            const scoreBadge = document.getElementById('scoreBadge');
            scoreBadge.className = 'score-badge grade-' + score.grade;

            // å½“å‰ä¿¡å·
            const signalMap = {
                2: 'ğŸ”¥ å¼ºçƒˆä¹°å…¥',
                1: 'ğŸ”º ä¹°å…¥',
                0: 'â¸ï¸ è§‚æœ›',
                '-1': 'ğŸ”» å–å‡º',
                '-2': 'ğŸ’€ å¼ºçƒˆå–å‡º'
            };

            const signals = data.current_signals;
            const signalsHtml = `
                <div class="col-md-6 mb-2">MA+MACD: ${signalMap[signals.signal]}</div>
                <div class="col-md-6 mb-2">å¸ƒæ—å¸¦: ${signalMap[signals.signal_boll]}</div>
                <div class="col-md-6 mb-2">KDJ: ${signalMap[signals.signal_kdj]}</div>
                <div class="col-md-6 mb-2">RSI: ${signalMap[signals.signal_rsi]}</div>
                <div class="col-md-6 mb-2">æˆäº¤é‡: ${signalMap[signals.signal_volume]}</div>
                <div class="col-md-6 mb-2"><strong>ç»¼åˆç­–ç•¥: ${signalMap[signals.signal_combined]}</strong></div>
            `;
            document.getElementById('signalsContainer').innerHTML = signalsHtml;

            // ç­–ç•¥å¯¹æ¯”
            const strategies = data.strategies;
            let tableHtml = '';
            for (const [name, strat] of Object.entries(strategies)) {
                if (strat.trade_count > 0) {
                    tableHtml += `
                        <tr>
                            <td><strong>${name}</strong></td>
                            <td>${strat.trade_count} ç¬”</td>
                            <td class="${strat.annual_return > 0 ? 'text-success' : 'text-danger'}">
                                ${strat.annual_return.toFixed(1)}%
                            </td>
                            <td>${strat.win_rate.toFixed(1)}%</td>
                            <td>${strat.sharpe_ratio.toFixed(2)}</td>
                            <td class="text-danger">${strat.max_drawdown.toFixed(2)}%</td>
                        </tr>
                    `;
                }
            }
            document.getElementById('strategyTableBody').innerHTML = tableHtml;

            // è¯„åˆ†æ˜ç»†
            const detailsHtml = `
                <li>è¶‹åŠ¿ (${score.trend}/30): ${score.trend_text}</li>
                <li>RSI (${score.rsi}/20): ${score.rsi_text}</li>
                <li>é‡èƒ½ (${score.volume}/10): ${score.volume_text}</li>
                <li>ç­–ç•¥ (${score.strategy_winrate + score.strategy_return + score.strategy_sharpe}/40): ${score.strategy_text}</li>
            `;
            document.getElementById('scoreDetails').innerHTML = detailsHtml;

            // æ˜¾ç¤ºç»“æœå¡ç‰‡
            document.getElementById('resultCard').style.display = 'block';
            document.getElementById('resultCard').scrollIntoView({ behavior: 'smooth' });
        }
    </script>
</body>
</html>
